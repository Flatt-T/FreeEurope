<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EuroLingo ‚Äî Multilingual Voice Tutor</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0f1d;--panel:#0f172a;--text:#e6eef8;--muted:#9fb0c7;--accent:#22d3ee;--danger:#ef4444;--border:#1e293b;--chip:#152338}
  *{box-sizing:border-box} html,body{margin:0;background:linear-gradient(180deg,#080c19,#0c1224 30%,#0b1220);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(10,15,29,.75);backdrop-filter:blur(10px) saturate(140%);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid #233047;border-radius:999px;background:#0b1220;color:var(--muted)}
  .xpbar{width:140px;height:8px;border-radius:999px;background:#0b1327;overflow:hidden;border:1px solid #16233a}
  .xpbar>div{height:100%;background:linear-gradient(90deg,var(--accent),#38bdf8);width:0}
  main{max-width:1200px;margin:12px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .pad{padding:12px} .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:12px;padding:10px 14px;background:#1f2937;color:#fff;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25)}
  .primary{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#01151a;font-weight:800}
  .danger{background:var(--danger)} .muted{color:var(--muted)}
  input,select{background:#0b1220;border:1px solid #24324c;color:var(--text);border-radius:10px;padding:8px 10px}
  .big{padding:14px 18px;font-size:1.05em;border-radius:14px}

  .chat{display:grid;grid-template-rows:auto 1fr auto;min-height:48vh;border-radius:16px;overflow:hidden}
  .chat .top{padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0b142a,#0d1733)}
  .chat .mid{background:#081023;overflow:auto;padding:12px}
  .bubble{max-width:86%;margin:8px 0;padding:10px 12px;border-radius:14px;border:1px solid #1b2a44;background:#0d1530}
  .me{background:#132039;border-color:#253b61;margin-left:auto}
  .sys{background:#112;color:#b8c1d6;font-style:italic}
  .subtitle{font-size:.9em;color:#b8cbe3;margin-top:4px;opacity:.95}
  .badge{background:linear-gradient(90deg,#111b36,#182646);border:1px solid #263a62;padding:6px 10px;border-radius:999px;font-size:.9em}
  .lvl{font-weight:800;color:#c7e7ff}

  .meters{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:10px}
  @media(min-width:780px){.meters{grid-template-columns:repeat(4,1fr)}}
  .meter{background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:10px}
  .meter h4{margin:0 0 6px 0;font-size:12px}
  .bar{height:8px;border-radius:8px;background:#091528;border:1px solid #163054;overflow:hidden}
  .bar>div{height:100%;background:linear-gradient(90deg,#34d399,#22c55e);width:0}
  .coach{font-size:.85em;color:#9fb0c7;margin-top:6px;min-height:1.3em}

  .deck .title{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .flash{padding:12px;display:grid;gap:8px}
  .cardsRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:760px){.cardsRow{grid-template-columns:1fr}}
  .card{min-height:110px;border:1px dashed #2a3a5c;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.05em;background:#09142b;padding:12px;text-align:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{background:#152338;border:1px solid #1e2e4f;padding:6px 10px;border-radius:999px;color:#c8d7ef;font-size:.9em}
  .score{font-weight:800}
</style>
<script defer src="https://unpkg.com/@mlc-ai/web-llm@0.2.58/dist/index.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üåç EuroLingo ‚Äî Multilingual Voice Tutor</h1>
    <div class="row">
      <span class="pill">Streak: <b id="streak">0</b> üî• ‚Ä¢ Combo: <b id="combo">x1</b></span>
      <div class="xpbar"><div id="xpfill"></div></div>
      <span class="pill"><b id="xp">0</b> XP</span>
      <span class="pill">LLM: <b id="llmSource">‚Äî</b></span>
    </div>
  </div>
  <div class="wrap" style="padding-top:0;padding-bottom:10px;gap:10px">
    <label for="langSelect" class="pill">Language</label>
    <select id="langSelect"></select>
  </div>
</header>

<main>
  <section class="panel chat">
    <div class="top">
      <div class="row">
        <button id="startBtn" class="primary big">‚ñ∂Ô∏è Start</button>
        <button id="stopBtn" class="danger big">‚èπÔ∏è Stop</button>
        <button id="interruptBtn" class="pill">‚õî Interrupt</button>
        <span id="status" class="pill">idle</span>
        <span class="pill" style="margin-left:auto">Level: <b id="level" class="lvl">A1</b></span>
      </div>
      <div class="muted" style="margin-top:6px">
        Speaks your chosen language with an English subtitle. Barge-in supported.
      </div>
    </div>
    <div id="chat" class="mid" aria-live="polite"></div>
    <div class="pad">
      <div class="row">
        <span class="badge">Focus: <b id="focusTag">‚Äî</b></span>
        <span class="badge">Weakest: <b id="weakTag">‚Äî</b></span>
        <span class="badge">Correct Streak: <b id="corrStreak">0</b></span>
      </div>
    </div>

    <div class="settings pad" style="border-top:1px dashed #20314f">
      <div class="section">
        <b>OpenRouter</b>
        <input id="orKey" type="password" placeholder="OpenRouter API key (recommended)"/>
        <input id="orModel" value="" size="42" placeholder="model id (auto-fallback enabled)"/>
        <label class="pill" style="gap:6px"><input type="checkbox" id="forceRemote"/> Force OpenRouter</label>
        <button id="saveOR" class="pill">Save</button>
        <button id="testOR" class="pill">Test</button>
        <span id="orStatus" class="muted"></span>
      </div>
      <div class="section">
        <b>Speech (optional)</b>
        <input id="groqKey" type="password" placeholder="Groq API key for Whisper STT"/>
        <button id="saveGroq" class="pill">Save</button>
        <span id="groqStatus" class="muted"></span>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="meters">
      <div class="meter"><h4>Pronunciation</h4><div class="bar"><div id="pronBar"></div></div><div class="coach" id="pronTip">‚Äî</div></div>
      <div class="meter"><h4>Accent</h4><div class="bar"><div id="accentBar"></div></div><div class="coach" id="accentTip">‚Äî</div></div>
      <div class="meter"><h4>Fluency</h4><div class="bar"><div id="fluencyBar"></div></div><div class="coach" id="fluencyTip">‚Äî</div></div>
      <div class="meter"><h4>Confidence</h4><div class="bar"><div id="confBar"></div></div><div class="coach" id="confTip">‚Äî</div></div>
    </div>
  </section>

  <section class="panel deck">
    <div class="title">
      <span>üÉè Adaptive Flashcards (AI-checked ‚Äúsay it‚Äù)</span>
      <span class="pill" style="margin-left:auto">Due: <b id="dueCount">0</b></span>
    </div>
    <div class="flash">
      <div class="cardsRow">
        <div id="fcFront" class="card front">Front (English)</div>
        <div id="fcBack" class="card back">Back (Target language)</div>
      </div>
      <div class="controls">
        <button id="prevCard" class="pill">‚¨ÖÔ∏è Prev</button>
        <button id="nextCard" class="pill">Next ‚û°Ô∏è</button>
        <button id="showCard" class="pill">Flip</button>

        <button id="again" class="pill">Again</button>
        <button id="hard" class="pill">Hard</button>
        <button id="good" class="pill">Good</button>
        <button id="easy" class="primary">Easy</button>

        <span class="chip" id="deckInfo">Module: ‚Äî</span>

        <button id="speakCard" class="primary big">üîä Speak Card</button>
        <button id="sayCard" class="primary big">üé§ I‚Äôll say it</button>
        <span id="sayResult" class="muted"></span>
        <span id="sayScore" class="chip score"></span>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Languages ===== */
const LANGS = [
  {key:'es', label:'Espa√±ol',  tts:'es-ES', stt:'es-ES', tag:'ES', tutor:'Profe de Viaje'},
  {key:'de', label:'Deutsch',  tts:'de-DE', stt:'de-DE', tag:'DE', tutor:'Reisecoach'},
  {key:'fr', label:'Fran√ßais', tts:'fr-FR', stt:'fr-FR', tag:'FR', tutor:'Coach de voyage'},
  {key:'it', label:'Italiano', tts:'it-IT', stt:'it-IT', tag:'IT', tutor:'Coach di viaggio'},
  {key:'pt', label:'Portugu√™s',tts:'pt-PT', stt:'pt-PT', tag:'PT', tutor:'Treinador de viagem'},
  {key:'pl', label:'Polski',   tts:'pl-PL', stt:'pl-PL', tag:'PL', tutor:'Trener podr√≥≈ºy'},
  {key:'lt', label:'Lietuvi≈≥', tts:'lt-LT', stt:'lt-LT', tag:'LT', tutor:'Kelioni≈≥ treneris'},
  {key:'nl', label:'Nederlands',tts:'nl-NL',stt:'nl-NL', tag:'NL', tutor:'Reiscoach'},
  {key:'sv', label:'Svenska',  tts:'sv-SE', stt:'sv-SE', tag:'SV', tutor:'Resecoach'},
  {key:'da', label:'Dansk',    tts:'da-DK', stt:'da-DK', tag:'DA', tutor:'Rejsecoach'},
  {key:'nb', label:'Norsk',    tts:'nb-NO', stt:'nb-NO', tag:'NO', tutor:'Reisecoach'},
  {key:'fi', label:'Suomi',    tts:'fi-FI', stt:'fi-FI', tag:'FI', tutor:'Matkavalmentaja'},
  {key:'el', label:'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨', tts:'el-GR', stt:'el-GR', tag:'EL', tutor:'Œ†œÅŒøœÄŒøŒΩŒ∑œÑŒÆœÇ œÑŒ±ŒæŒπŒ¥ŒπŒøœç'},
  {key:'cs', label:'ƒåe≈°tina',  tts:'cs-CZ', stt:'cs-CZ', tag:'CS', tutor:'Tren√©r cestov√°n√≠'},
  {key:'hu', label:'Magyar',   tts:'hu-HU', stt:'hu-HU', tag:'HU', tutor:'Utaz√°si edz≈ë'},
  {key:'ro', label:'Rom√¢nƒÉ',   tts:'ro-RO', stt:'ro-RO', tag:'RO', tutor:'Antrenor de cƒÉlƒÉtorie'},
  {key:'bg', label:'–ë—ä–ª–≥–∞—Ä—Å–∫–∏',tts:'bg-BG', stt:'bg-BG', tag:'BG', tutor:'–¢—Ä–µ–Ω—å–æ—Ä –ø–æ –ø—ä—Ç—É–≤–∞–Ω–∏—è'}
];

/* ===== Config & Fallbacks ===== */
const EMBEDDED_OR_KEY = "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";
const FALLBACK_MODELS = [
  "google/gemini-flash-1.5",
  "meta-llama/llama-3.1-70b-instruct:free",
  "meta-llama/llama-3.1-8b-instruct:free",
  "qwen/qwen-2.5-7b-instruct",
  "mistralai/mistral-small-latest"
];

/* ===== State ===== */
const S={level:'A1',scenario:'general',stop:true,speaking:false,history:[],deck:[],lang:localStorage.getItem('lang_key')||'es',currentIndex:0,lastExpected:"",lastEN:"",turn:0,userFacts:{}};
const cfg={
  openrouterKey: localStorage.getItem('or_key') || EMBEDDED_OR_KEY,
  openrouterModel: localStorage.getItem('or_model') || FALLBACK_MODELS[0],
  groqKey: localStorage.getItem('groq_key') || '',
  forceRemote: JSON.parse(localStorage.getItem('force_remote') || 'false')
};

/* ===== UI refs ===== */
const chatEl=document.getElementById('chat'),statusEl=document.getElementById('status'),llmSourceEl=document.getElementById('llmSource');
const xpEl=document.getElementById('xp'),xpFill=document.getElementById('xpfill');const levelEl=document.getElementById('level');
const sayRes=document.getElementById('sayResult'),sayScoreEl=document.getElementById('sayScore');
const langSelect=document.getElementById('langSelect');
const forceRemote=document.getElementById('forceRemote');

/* ===== Helpers ===== */
function esc(s){return (s||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}
function L(){return LANGS.find(x=>x.key===S.lang)||LANGS[0]}
function scrollChat(){requestAnimationFrame(()=>chatEl.scrollTo({top:chatEl.scrollHeight,behavior:'smooth'}))}
function logAssistant(native,en){const d=document.createElement('div');d.className='bubble';d.innerHTML=`<strong>Tutor:</strong> ${esc(native)}<div class="subtitle">EN: ${esc(en)}</div>`;chatEl.appendChild(d);scrollChat()}
function logUser(t){const d=document.createElement('div');d.className='bubble me';d.innerHTML=`<strong>You:</strong> ${esc(t)}`;chatEl.appendChild(d);scrollChat()}
function logSys(t){const d=document.createElement('div');d.className='bubble sys';d.textContent=t;chatEl.appendChild(d);scrollChat()}
function setStatus(t){statusEl.textContent=t}

/* ===== Language Dropdown ===== */
function renderLangSelect(){
  langSelect.innerHTML='';
  LANGS.forEach(x=>{
    const opt=document.createElement('option'); opt.value=x.key; opt.textContent=x.label; if(x.key===S.lang) opt.selected=true; langSelect.appendChild(opt);
  });
  langSelect.onchange=()=>{
    S.lang=langSelect.value; localStorage.setItem('lang_key',S.lang);
    loadDeck(); if(!S.deck.length) seedDeckForLang(S.lang);
    showCard(0); resetConversation(true);
  };
}

/* ===== TTS / Speech ===== */
async function speak(text,code){if(!('speechSynthesis'in window))return;return new Promise(res=>{const u=new SpeechSynthesisUtterance(text);u.lang=code;u.rate=1.0;S.speaking=true;u.onend=()=>{S.speaking=false;res()};u.onerror=()=>{S.speaking=false;res()};try{speechSynthesis.cancel();}catch{}speechSynthesis.speak(u);});}
function cancelSpeak(){try{speechSynthesis.cancel();}catch{}S.speaking=false}

/* ===== STT ===== */
function hasBrowserSTT(){return !!(window.SpeechRecognition||window.webkitSpeechRecognition)}
function newRecognizer(lang){const C=window.SpeechRecognition||window.webkitSpeechRecognition;const r=new C();r.lang=lang;r.interimResults=false;r.maxAlternatives=1;return r}
async function listenBrowser(lang){return new Promise(resolve=>{if(!hasBrowserSTT()){logSys('Speech recognition not supported in this browser.');return resolve('');}const r=newRecognizer(lang);setStatus('üéôÔ∏è listening‚Ä¶');let done=false;const killer=setTimeout(()=>{if(!done){try{r.abort();}catch{}}},16000);r.onresult=e=>{done=true;clearTimeout(killer);setStatus('processing‚Ä¶');resolve(e.results[0]?.[0]?.transcript||'')};r.onerror=()=>{if(!done){done=true;clearTimeout(killer);resolve('')}};r.onend=()=>{if(!done){done=true;clearTimeout(killer);resolve('')}};try{r.start()}catch{resolve('')}})}
async function recordBlob(ms=8000){if(!navigator.mediaDevices?.getUserMedia)return null;const s=await navigator.mediaDevices.getUserMedia({audio:true});const rec=new MediaRecorder(s,{mimeType:'audio/webm'});const chunks=[];rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data)};const stopped=new Promise(r=>{rec.onstop=()=>r()});rec.start();setStatus('üéôÔ∏è listening‚Ä¶');await new Promise(r=>setTimeout(r,ms));rec.stop();await stopped;s.getTracks().forEach(t=>t.stop());return new Blob(chunks,{type:'audio/webm'})}
async function listenGroq(lang){try{const b=await recordBlob(7000);if(!b)return'';const f=new FormData();f.append('file',b,'speech.webm');f.append('model','whisper-large-v3-turbo');f.append('language',(lang||'en-GB').slice(0,2));const r=await fetch('https://api.groq.com/openai/v1/audio/transcriptions',{method:'POST',headers:{'Authorization':'Bearer '+cfg.groqKey},body:f});if(!r.ok)throw new Error('groq stt error');const j=await r.json();return j.text||''}catch{return''}}
async function listen(lang){return cfg.groqKey?await listenGroq(lang):await listenBrowser(lang)}

/* ===== OpenRouter + Local (with diagnostics & fallbacks) ===== */
let webllmEngine=null,webllmReady=false;
async function initWebLLM(){ if(webllmReady)return; if(!('mlc'in window))throw new Error('WebLLM missing');
  const cb=(x)=>setStatus('loading: '+(x.text||'')); try{ webllmEngine=await mlc.createMLCEngine("Qwen2-1.5B-Instruct-q4f32_1",{initProgressCallback:cb}) }catch{ webllmEngine=await mlc.createMLCEngine("Qwen2-0.5B-Instruct-q4f32_1",{initProgressCallback:cb}) } webllmReady=true; }
async function wllmChat(messages,max=220){ await initWebLLM(); const out=await webllmEngine.chat.completions.create({messages,temperature:0.7,max_tokens:max,stream:false}); return out.choices?.[0]?.message?.content||'' }

function makeHeaders(){
  const hdr={'Content-Type':'application/json','Authorization':'Bearer '+cfg.openrouterKey,'X-Title':'EuroLingo Tutor'};
  try{ if(/^https?:\/\//i.test(location.origin)) hdr['HTTP-Referer']=location.origin; }catch{}
  return hdr;
}
async function tryModel(messages, model, max=220){
  const body={model, messages, temperature:0.7, max_tokens:max};
  const resp=await fetch('https://openrouter.ai/api/v1/chat/completions',{
    method:'POST', mode:'cors', credentials:'omit',
    headers: makeHeaders(),
    body: JSON.stringify(body)
  });
  const text=await resp.text();
  if(!resp.ok){
    const err=new Error('http-'+resp.status+': '+text.slice(0,280));
    err.status=resp.status; err.body=text; throw err;
  }
  const j=JSON.parse(text);
  return (j.choices?.[0]?.message?.content||'').trim();
}
async function orChat(messages,max=220){
  if(!cfg.openrouterKey) throw new Error('no-key');
  // 1) try configured model
  try{
    return await tryModel(messages, cfg.openrouterModel, max);
  }catch(e){
    if(String(e.status)!=='404') throw e; // only fallback on 404
  }
  // 2) rotate fallbacks
  let lastErr=null;
  for(const m of FALLBACK_MODELS){
    try{
      const out=await tryModel(messages, m, max);
      cfg.openrouterModel=m; localStorage.setItem('or_model',m);
      const orStatus=document.getElementById('orStatus'); if(orStatus) orStatus.textContent=`Switched to ${m} ‚úÖ`;
      return out;
    }catch(err){ lastErr=err; }
  }
  throw lastErr||new Error('No working model found');
}

/* ===== Conversational Prompt ===== */
function sysPrompt(){
  return `
You are "${L().tutor}", a ${L().label} travel tutor. Answer the user's content directly.

FORMAT ‚Äî EXACTLY TWO LINES:
${L().tag}: <natural ${L().label}, ‚â§60 words. Answer what they said; give a tiny inline correction if needed; ask one short, relevant follow-up; vary context. If they asked "how do I say/what does/(local equivalent)", give the ${L().label} phrase first in quotes, then continue. Never start with "Tutor:".>
EN: <5‚Äì15 word English subtitle paraphrasing the ${L().tag} line>

Avoid generic ‚Äúcontinue?‚Äù prompts unless the user is silent or unclear twice in a row.
`.trim();
}

/* ===== Parsing ===== */
function parseTwo(text){
  const TAG=L().tag;
  const raw=(text||"").replace(/^\s*(Tutor|Assistant)\s*:\s*/i,"");
  let m1=new RegExp(`^\\s*${TAG}:\\s*(.+)$`,"im").exec(raw);
  let m2=/^\s*EN:\s*(.+)$/im.exec(raw);
  if(m1&&m2) return {nat:m1[1].trim(),en:m2[1].trim()};
  const allTags=LANGS.map(x=>x.tag).join("|");
  m1=new RegExp(`^\\s*(?:${allTags}):\\s*(.+)$`,"im").exec(raw);
  if(m1&&m2) return {nat:m1[1].trim(),en:m2[1].trim()};
  const lines=raw.split("\n").map(s=>s.trim()).filter(Boolean);
  return {nat:(lines[0]||"¬øSeguimos?"),en:(lines[1]||"Let‚Äôs keep going.")};
}

/* ===== Simple facts to stay on-topic ===== */
function updateFactsFromUser(uttr){
  const s=(uttr||'').toLowerCase();
  if(/hotel|hostel|airbnb|check/.test(s)) S.userFacts.context='hotel';
  if(/taxi|uber|cab|airport|flight/.test(s)) S.userFacts.context='transport';
  if(/vegetarian|vegan|allerg/.test(s)) S.userFacts.diet='diet';
  const place=(s.match(/\b(paris|madrid|berlin|rome|lisbon|athens|vienna|prague|budapest|bucharest|sofia|amsterdam|stockholm|oslo|helsinki)\b/)||[])[1];
  if(place) S.userFacts.city=place;
}

/* ===== Scenario + meters ===== */
function detectScenario(t){const s=(t||'').toLowerCase();if(/resta|menu|camar|rechnung|tisch|gar√ßon|bill|mesa|men√∫|speisekarte|kellner|carte|order|dish/.test(s))return 'restaurant';if(/taxi|airport|aeropuerto|flughafen|a√©roport|gare|station|metro|bus|train|ubahn|u-bahn|flight/.test(s))return 'taxi';if(/direc|left|right|straight|izquierda|derecha|gauche|droite|links|rechts|geradeaus|wo ist|map/.test(s))return 'directions';if(/hotel|room|check|llave|schl√ºssel|cl√©|fr√ºhst√ºck|desayuno|reception|reservation/.test(s))return 'hotel';if(/money|euros?|price|precio|wie viel|combien|tarjeta|efectivo|cash|atm/.test(s))return 'money';if(/help|ayuda|hilfe|police|polizei|ambulance|apotheke|farmacia|emergen|lost|stolen/.test(s))return 'emergencies';if(/friend|foto|recommend|recomienda|empfehl|social|smalltalk|charla|conversa|museum|bar|park/.test(s))return 'social';return S.scenario||'social'}
const bars={pron:document.getElementById('pronBar'),accent:document.getElementById('accentBar'),flu:document.getElementById('fluencyBar'),conf:document.getElementById('confBar')};
const tips={pron:document.getElementById('pronTip'),accent:document.getElementById('accentTip'),flu:document.getElementById('fluencyTip'),conf:document.getElementById('confTip')};
function norm(n){return Math.max(0,Math.min(100,Math.round(n)))}
function heuristic(user,expected){const a=(user||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();const b=(expected||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();const A=new Set(a.split('')),B=new Set(b.split(''));const inter=[...A].filter(x=>B.has(x)).length;const uni=new Set([...A,...B]).size||1;const sim=inter/uni;return{pron:norm(30+60*sim),accent:norm(30+60*sim),fluency:norm(30+Math.min(70,(user.split(/\s+/).length||0)*6)),confidence:norm(25+Math.min(75,(user.length||0)/40*75)),feedback:"Heuristic only."}}
async function aiScore(user,expected){try{const sys=`You are a strict ${L().label} pronunciation coach. Return JSON: {"pron":0-100,"accent":0-100,"fluency":0-100,"confidence":0-100,"feedback":"<=15 words"}. Penalise English or wrong language.`;const usr=`LanguageTag=${L().tag}\nTarget="${expected||''}"\nUserSaid="${user||''}"`;const raw=await orChat([{role:'system',content:sys},{role:'user',content:usr}],150);const json=JSON.parse((raw.match(/\{[\s\S]*\}$/)||[raw])[0]);return{pron:norm(json.pron),accent:norm(json.accent),fluency:norm(json.fluency),confidence:norm(json.confidence),feedback:String(json.feedback||'Good effort.').slice(0,60)}}catch{return heuristic(user,expected)}}
function updMeters(o){bars.pron.style.width=o.pron+'%';tips.pron.textContent=o.feedback||'';bars.accent.style.width=o.accent+'%';tips.accent.textContent=o.accent<55?'Mind stress & vowels.':'Accent improving.';bars.flu.style.width=o.fluency+'%';tips.flu.textContent=o.fluency<55?'Short, complete clauses.':'Good flow.';bars.conf.style.width=o.confidence+'%';tips.conf.textContent=o.confidence<55?'Steady pace, project.':'Confident tone.'}

/* ===== Flashcards (per-language) ===== */
const FC={front:document.getElementById('fcFront'),back:document.getElementById('fcBack'),dueCount:document.getElementById('dueCount'),deckInfo:document.getElementById('deckInfo')};
function deckKey(){return 'deck_multi_v4_'+S.lang}
function days(n){return n*86400000}
function loadDeck(){try{S.deck=JSON.parse(localStorage.getItem(deckKey())||'[]')}catch{S.deck=[]}}
function saveDeck(){localStorage.setItem(deckKey(),JSON.stringify(S.deck||[]))}
function newCard(en,native,mod){return{id:`${S.lang}::${mod||'focus'}::${native}`,lang:S.lang,frontEN:en,backNative:native,ease:2.5,interval:0,due:Date.now(),reps:0,lapses:0,module:mod||'focus'}}
function reviewCard(c,g){const n={...c};if(g===0){n.lapses++;n.interval=0;n.ease=Math.max(1.3,n.ease-0.2);n.due=Date.now()+days(0.04)}else{if(n.interval===0)n.interval=(g===3?3:1);else if(n.interval===1)n.interval=(g===3?6:3);else n.interval=Math.round(n.interval*(n.ease)*(g===1?0.7:1));n.ease=Math.max(1.3,n.ease+(g===3?0.15:(g===1?-0.05:0.05)));n.due=Date.now()+days(n.interval)}n.reps++;return n}
function addToDeck(en,native,mod){if(!en||!native)return;const id=`${S.lang}::${mod||'focus'}::${native}`;if(S.deck.find(d=>d.id===id))return;S.deck.push(newCard(en,native,mod));saveDeck()}
function showCard(i){if(!S.deck.length){FC.front.textContent="No cards yet for this language.";FC.back.textContent="Practice will appear here.";FC.dueCount.textContent='0';FC.deckInfo.textContent='Module: ‚Äî';S.lastExpected='';S.lastEN='';return}S.currentIndex=((i%S.deck.length)+S.deck.length)%S.deck.length;const c=S.deck[S.currentIndex];FC.front.textContent=c.frontEN;FC.back.textContent=c.backNative;const due=S.deck.filter(k=>k.due<=Date.now());FC.dueCount.textContent=String(due.length||S.deck.length);FC.deckInfo.textContent='Module: '+(c.module||'focus');S.lastExpected=c.backNative;S.lastEN=c.frontEN}
function gradeCard(g){if(!S.deck.length)return;const i=S.currentIndex;S.deck[i]=reviewCard(S.deck[i],g);saveDeck();showCard(i+1)}
document.getElementById('prevCard').onclick=()=>{if(S.deck.length)showCard(S.currentIndex-1)}
document.getElementById('nextCard').onclick=()=>{if(S.deck.length)showCard(S.currentIndex+1)}
document.getElementById('showCard').onclick=()=>{}
document.getElementById('again').onclick=()=>gradeCard(0);document.getElementById('hard').onclick=()=>gradeCard(1);document.getElementById('good').onclick=()=>gradeCard(2);document.getElementById('easy').onclick=()=>gradeCard(3)
document.getElementById('speakCard').onclick=()=>{const c=S.deck[S.currentIndex];if(c)speak(c.backNative,L().tts)}
document.getElementById('sayCard').onclick=async()=>{const c=S.deck[S.currentIndex];if(!c)return;const heard=await listen(L().stt);document.getElementById('sayResult').textContent=heard?('You said: '+heard):'';if(!heard)return;const res=await aiScore(heard,c.backNative);updMeters(res);const label=res.pron>=85?'Excellent':res.pron>=70?'Good':res.pron>=50?'Fair':'Poor';document.getElementById('sayScore').textContent=`Score: ${label} (${res.pron})`}

/* ===== Harvest phrases ===== */
function harvest(native,en){const m=native.match(/[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]([^‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]+)[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]/);const phrase=(m?.[1]||'').trim();if(phrase)addToDeck(en||'‚Äî',phrase,S.scenario)}

/* ===== Idle prompt ===== */
function idlePrompt(){const map={es:{nat:'‚ÄúPerd√≥n, ¬øpodr√≠as repetirlo?‚Äù Dime qu√© pas√≥ o qu√© necesitas.',en:'Sorry‚Äîplease repeat or say what you need.'},de:{nat:'‚ÄûEntschuldigung, k√∂nntest du das wiederholen?‚Äú Sag mir, was gerade los ist.',en:'Please repeat or tell me what happened.'},fr:{nat:'¬´ Pardon, tu peux r√©p√©ter ? ¬ª Dis-moi ce qui se passe.',en:'Please repeat or tell me what‚Äôs up.'}};const t=map[L().key]||map.es;return `${L().tag}: ${t.nat}\nEN: ${t.en}`}

/* ===== Conversation assembly ===== */
function baseSystem(){return sysPrompt()+`\nScenario: ${S.scenario}. Known facts: ${JSON.stringify(S.userFacts)}.`}
function msgs(user){const h=[{role:'system',content:baseSystem()},...S.history.slice(-10)];if(user!=null)h.push({role:'user',content:user});return h}

/* ===== Reply with strict error handling ===== */
async function reply(userText){
  let raw='', used='OpenRouter';
  try{
    raw=await orChat(msgs(userText));
    llmSourceEl.textContent='OpenRouter';
  }catch(e){
    const msg=(e && e.message)?e.message:'unknown';
    logSys('OpenRouter failed ‚Üí '+msg);
    document.getElementById('orStatus').textContent='OpenRouter error: '+msg;
    if(cfg.forceRemote){ throw new Error('remote-required'); }
    used='Local';
    try{ raw=await wllmChat(msgs(userText)) }catch{ raw='' }
    llmSourceEl.textContent='Local';
  }
  let {nat,en}=parseTwo(raw);
  if((/¬øSeguimos|Pick a topic|continue/i.test(nat)||!nat) && userText){
    const scen=detectScenario(userText);
    const targeted={restaurant:'‚Äú¬øQuieres pedir algo en concreto?‚Äù ¬øEntrada o plato principal?',taxi:'‚ÄúTe llevo.‚Äù ¬øDirecci√≥n exacta o punto de referencia?',directions:'‚ÄúSigue recto, luego a la izquierda.‚Äù ¬øQu√© lugar buscas?',hotel:'‚ÄúTengo una reserva.‚Äù ¬øCheck-in ahora o preguntas sobre desayuno?',money:'‚Äú¬øPuedo pagar con tarjeta?‚Äù ¬øPresupuesto aproximado?',emergencies:'‚ÄúNecesito ayuda.‚Äù ¬øQu√© pas√≥ y d√≥nde est√°s?',social:'‚Äú¬øViajas por trabajo o placer?‚Äù ¬øCu√°ntos d√≠as te quedas?',general:'‚ÄúPerfecto.‚Äù Dame un detalle m√°s y te ayudo.'}[scen];
    if(targeted){nat=targeted;en='Okay‚Äîlet‚Äôs handle what you just said.'}
  }
  return {nat,en,used};
}

/* ===== Turn handling ===== */
let listening=false, unclearCount=0;
async function safeListen(lang,timeoutMs=12000){listening=true;setStatus('üéôÔ∏è listening‚Ä¶');const timer=new Promise(r=>setTimeout(()=>r('__TIMEOUT__'),timeoutMs));const heard=await Promise.race([listen(lang),timer]);listening=false;return heard==='__TIMEOUT__'?'':heard}
async function handleTurn(text){
  if(!text){
    unclearCount++;
    const {nat,en}=parseTwo(idlePrompt());
    logAssistant(nat,en); S.lastExpected=nat; S.lastEN=en;
    setStatus('speaking‚Ä¶'); await speak(nat,L().tts); setStatus('ready');
    S.history.push({role:'assistant',content:`${L().tag}: ${nat}\nEN: ${en}`});
    return;
  }
  unclearCount=0;
  logUser(text); S.scenario=detectScenario(text); updateFactsFromUser(text);
  setStatus('thinking‚Ä¶');
  let out;
  try{
    out=await reply(text);
  }catch(e){
    setStatus('OpenRouter required ‚Äî fix key/origin/model and press Start');
    return;
  }
  const {nat,en}=out;
  logAssistant(nat,en); S.lastExpected=nat; S.lastEN=en;
  setStatus('speaking‚Ä¶'); await speak(nat,L().tts); setStatus('ready');
  S.history.push({role:'user',content:text}); S.history.push({role:'assistant',content:`${L().tag}: ${nat}\nEN: ${en}`});
  harvest(nat,en);
  const expected=(nat.match(/[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]([^‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]+)[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]/)?.[1]||nat);
  const sc=await aiScore(text,expected); updMeters(sc);
}
async function start(){
  if(!S.stop) return; S.stop=false; levelEl.textContent=S.level;
  if(navigator.mediaDevices?.getUserMedia){try{await navigator.mediaDevices.getUserMedia({audio:true}).then(s=>s.getTracks().forEach(t=>t.stop())).catch(()=>{})}catch{}}
  setStatus('speaking‚Ä¶');
  const greetMap={es:"¬°Hola! Soy tu profe. Cu√©ntame qu√© pas√≥ o qu√© necesitas ahora mismo.",de:"Hallo! Ich bin dein Reisecoach. Sag mir, was gerade los ist.",fr:"Salut ! Je suis ton coach. Dis-moi ce dont tu as besoin maintenant."};
  const greet=greetMap[L().key]||"¬°Hola! Dime qu√© necesitas ahora mismo.";
  logAssistant(greet,"Tell me what you need right now.");
  await speak(greet,L().tts);
  setStatus('üéôÔ∏è listening‚Ä¶');
  while(!S.stop){
    if(S.speaking) cancelSpeak();
    const heard=await safeListen(S.level==='A1'?'en-GB':L().stt,12000);
    if(S.stop) break;
    await handleTurn(heard);
  }
}
function stopAll(){S.stop=true;cancelSpeak();setStatus('stopped')}
function resetConversation(notify){S.stop=true;S.history=[];S.scenario='general';if(notify)logSys(`Language set to ${L().label}. Press Start.`)}

/* ===== Controls & Settings ===== */
document.getElementById('startBtn').onclick=()=>{setStatus('starting‚Ä¶');start()}
document.getElementById('stopBtn').onclick=()=>stopAll()
document.getElementById('interruptBtn').onclick=()=>{cancelSpeak();setStatus('interrupted ‚Üí listening')}

document.getElementById('saveOR').onclick=()=>{
  const k=(document.getElementById('orKey').value||'').trim();
  const m=(document.getElementById('orModel').value||'').trim();
  if(k) cfg.openrouterKey=k;
  if(m) cfg.openrouterModel=m;
  cfg.forceRemote=!!document.getElementById('forceRemote').checked;
  localStorage.setItem('or_key',cfg.openrouterKey);
  localStorage.setItem('or_model',cfg.openrouterModel);
  localStorage.setItem('force_remote',JSON.stringify(cfg.forceRemote));
  document.getElementById('orStatus').textContent='Saved.';
}
document.getElementById('testOR').onclick=async()=>{
  const el=document.getElementById('orStatus');
  el.textContent='Testing‚Ä¶';
  try{
    const ok=await orChat([{role:'system',content:'Say "OK" only.'},{role:'user',content:'Respond.'}],6);
    el.textContent=`OpenRouter OK ‚úÖ (model: ${cfg.openrouterModel})`;
    llmSourceEl.textContent='OpenRouter';
  }catch(e){
    el.textContent='OpenRouter error ‚ùå ('+(e.message||'unknown')+')';
    llmSourceEl.textContent='‚Äî';
  }
}
document.getElementById('saveGroq').onclick=()=>{
  cfg.groqKey=(document.getElementById('groqKey').value||'').trim();
  localStorage.setItem('groq_key',cfg.groqKey);
  document.getElementById('groqStatus').textContent=cfg.groqKey?'STT via Groq Whisper':'STT via browser'
}

/* ===== Seeding per-language ===== */
function seedDeckForLang(lang){
  const seed={es:[["A table for two, please","Una mesa para dos, por favor","restaurant"],["Where is the metro?","¬øD√≥nde est√° el metro?","directions"],["The bill, please","La cuenta, por favor","restaurant"]],
              de:[["To the airport, please","Zum Flughafen, bitte.","taxi"],["Where is the metro?","Wo ist die U-Bahn?","directions"],["The bill, please","Die Rechnung, bitte.","restaurant"]],
              fr:[["Where is the metro?","O√π est le m√©tro ?","directions"],["Do you take card?","Je peux payer par carte ?","money"],["The bill, please","L‚Äôaddition, s‚Äôil vous pla√Æt.","restaurant"]]}[lang]
              || [["A table for two, please","Una mesa para dos, por favor","restaurant"]];
  S.deck=[]; seed.forEach(([en,native,mod])=>S.deck.push(newCard(en,native,mod))); saveDeck();
}

/* ===== Init ===== */
(function init(){
  // Prefill settings UI
  document.getElementById('orKey').value = cfg.openrouterKey;
  document.getElementById('orModel').value = cfg.openrouterModel;
  document.getElementById('forceRemote').checked = cfg.forceRemote;

  renderLangSelect();
  document.getElementById('streak').textContent='0';document.getElementById('combo').textContent='x1';document.getElementById('xp').textContent='0';levelEl.textContent=S.level;

  loadDeck(); if(!S.deck.length) seedDeckForLang(S.lang); showCard(0);
  logSys("Tip: serve over https or localhost. Test to confirm OpenRouter; badge shows the active engine.");
})();
</script>
</body>
</html>
