<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EuroLingo ‚Äî Multilingual Voice Tutor (Fluid + AI Pronunciation)</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0f1d;--panel:#0f172a;--text:#e6eef8;--muted:#9fb0c7;--accent:#22d3ee;--danger:#ef4444;--border:#1e293b;--chip:#152338}
  *{box-sizing:border-box} html,body{margin:0;background:linear-gradient(180deg,#080c19,#0c1224 30%,#0b1220);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(10,15,29,.75);backdrop-filter:blur(10px) saturate(140%);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid #233047;border-radius:999px;background:#0b1220;color:var(--muted)}
  .xpbar{width:140px;height:8px;border-radius:999px;background:#0b1327;overflow:hidden;border:1px solid #16233a}
  .xpbar>div{height:100%;background:linear-gradient(90deg,var(--accent),#38bdf8);width:0}
  main{max-width:1200px;margin:12px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .pad{padding:12px} .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:12px;padding:10px 14px;background:#1f2937;color:var(--text);cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25)}
  .primary{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#01151a;font-weight:800}
  .danger{background:var(--danger)} .muted{color:var(--muted)}
  input{background:#0b1220;border:1px solid #24324c;color:var(--text);border-radius:10px;padding:8px 10px}
  .big{padding:14px 18px;font-size:1.05em;border-radius:14px}

  /* Language bar */
  .langbar{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0b142a,#0d1733)}
  .langbtn{padding:6px 10px;border-radius:999px;border:1px solid #284065;background:#0b1220;cursor:pointer}
  .langbtn.active{background:linear-gradient(90deg,#22d3ee,#60a5fa);color:#042d37;border-color:#2d6a87;font-weight:800}

  /* Chat */
  .chat{display:grid;grid-template-rows:auto 1fr auto;min-height:48vh;border-radius:16px;overflow:hidden}
  .chat .top{padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0b142a,#0d1733)}
  .chat .mid{background:#081023;overflow:auto;padding:12px}
  .bubble{max-width:86%;margin:8px 0;padding:10px 12px;border-radius:14px;border:1px solid #1b2a44;background:#0d1530}
  .me{background:#132039;border-color:#253b61;margin-left:auto}
  .sys{background:#112;color:#b8c1d6;font-style:italic}
  .subtitle{font-size:.9em;color:#b8cbe3;margin-top:4px;opacity:.95}
  .badge{background:linear-gradient(90deg,#111b36,#182646);border:1px solid #263a62;padding:6px 10px;border-radius:999px;font-size:.9em}
  .lvl{font-weight:800;color:#c7e7ff}

  /* Meters */
  .meters{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:10px}
  @media(min-width:780px){.meters{grid-template-columns:repeat(4,1fr)}}
  .meter{background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:10px}
  .meter h4{margin:0 0 6px 0;font-size:12px}
  .bar{height:8px;border-radius:8px;background:#091528;border:1px solid #163054;overflow:hidden}
  .bar>div{height:100%;background:linear-gradient(90deg,#34d399,#22c55e);width:0}
  .coach{font-size:.85em;color:var(--muted);margin-top:6px}

  /* Flashcards */
  .deck .title{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .flash{padding:12px;display:grid;gap:8px}
  .cardsRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:760px){.cardsRow{grid-template-columns:1fr}}
  .card{min-height:110px;border:1px dashed #2a3a5c;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.05em;background:#09142b;padding:12px;text-align:center}
  .back{display:none}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{background:#152338;border:1px solid #1e2e4f;padding:6px 10px;border-radius:999px;color:#c8d7ef;font-size:.9em}
  .score{font-weight:800}

  /* Settings */
  .settings{padding:10px;border-top:1px dashed #20314f;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .section{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
<script defer src="https://unpkg.com/@mlc-ai/web-llm@0.2.58/dist/index.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üåç EuroLingo ‚Äî Multilingual Voice Tutor</h1>
    <div class="row">
      <span class="pill">Streak: <b id="streak">0</b> üî• ‚Ä¢ Combo: <b id="combo">x1</b></span>
      <div class="xpbar"><div id="xpfill"></div></div>
      <span class="pill"><b id="xp">0</b> XP</span>
    </div>
  </div>
  <div id="langbar" class="wrap langbar"></div>
</header>

<main>
  <!-- Chat -->
  <section class="panel chat">
    <div class="top">
      <div class="row">
        <button id="startBtn" class="primary big">‚ñ∂Ô∏è Start</button>
        <button id="stopBtn" class="danger big">‚èπÔ∏è Stop</button>
        <button id="interruptBtn" class="pill">‚õî Interrupt</button>
        <span id="status" class="pill">idle</span>
        <span class="pill" style="margin-left:auto">Level: <b id="level" class="lvl">A1</b></span>
      </div>
      <div class="muted" style="margin-top:6px">
        Speaks your chosen language with a short English subtitle. <b>Listens immediately</b> and supports <b>barge-in</b> (interrupt while it‚Äôs speaking).
      </div>
    </div>
    <div id="chat" class="mid" aria-live="polite"></div>
    <div class="pad">
      <div class="row">
        <span class="badge">Focus: <b id="focusTag">‚Äî</b></span>
        <span class="badge">Weakest: <b id="weakTag">‚Äî</b></span>
        <span class="badge">Correct Streak: <b id="corrStreak">0</b></span>
      </div>
    </div>
    <!-- Settings -->
    <div class="settings">
      <div class="section">
        <b>OpenRouter</b>
        <input id="orKey" type="password" placeholder="OpenRouter API key (free models)"/>
        <input id="orModel" value="meta-llama/llama-3.2-11b-vision-instruct:free" size="42"/>
        <button id="saveOR" class="pill">Save</button>
        <span id="orStatus" class="muted"></span>
      </div>
      <div class="section">
        <b>Speech (optional)</b>
        <input id="groqKey" type="password" placeholder="Groq API key for Whisper STT"/>
        <button id="saveGroq" class="pill">Save</button>
        <span id="groqStatus" class="muted"></span>
      </div>
    </div>
  </section>

  <!-- Meters -->
  <section class="panel">
    <div class="meters">
      <div class="meter"><h4>Pronunciation</h4><div class="bar"><div id="pronBar"></div></div><div class="coach" id="pronTip">‚Äî</div></div>
      <div class="meter"><h4>Accent</h4><div class="bar"><div id="accentBar"></div></div><div class="coach" id="accentTip">‚Äî</div></div>
      <div class="meter"><h4>Fluency</h4><div class="bar"><div id="fluencyBar"></div></div><div class="coach" id="fluencyTip">‚Äî</div></div>
      <div class="meter"><h4>Confidence</h4><div class="bar"><div id="confBar"></div></div><div class="coach" id="confTip">‚Äî</div></div>
    </div>
  </section>

  <!-- Flashcards -->
  <section class="panel deck">
    <div class="title">
      <span>üÉè Adaptive Flashcards (AI-checked ‚Äúsay it‚Äù)</span>
      <span class="pill" style="margin-left:auto">Due: <b id="dueCount">0</b></span>
    </div>
    <div class="flash">
      <div class="cardsRow">
        <div id="fcFront" class="card front">Front (English)</div>
        <div id="fcBack" class="card back">Back (Target language)</div>
      </div>
      <div class="controls">
        <button id="prevCard" class="pill">‚¨ÖÔ∏è Prev</button>
        <button id="nextCard" class="pill">Next ‚û°Ô∏è</button>
        <button id="showCard" class="pill">Flip</button>

        <button id="again" class="pill">Again</button>
        <button id="hard" class="pill">Hard</button>
        <button id="good" class="pill">Good</button>
        <button id="easy" class="primary">Easy</button>

        <span class="chip" id="deckInfo">Module: ‚Äî</span>

        <button id="speakCard" class="primary big">üîä Speak Card</button>
        <button id="sayCard" class="primary big">üé§ I‚Äôll say it</button>
        <span id="sayResult" class="muted"></span>
        <span id="sayScore" class="chip score"></span>
      </div>
    </div>
  </section>
</main>

<script>
/* ========================= Language catalog ========================= */
const LANGS = [
  {key:'es', label:'Espa√±ol',  tts:'es-ES', stt:'es-ES', tag:'ES', tutor:'Profe de Viaje'},
  {key:'de', label:'Deutsch',  tts:'de-DE', stt:'de-DE', tag:'DE', tutor:'Reisecoach'},
  {key:'fr', label:'Fran√ßais', tts:'fr-FR', stt:'fr-FR', tag:'FR', tutor:'Coach de voyage'},
  {key:'it', label:'Italiano', tts:'it-IT', stt:'it-IT', tag:'IT', tutor:'Coach di viaggio'},
  {key:'pt', label:'Portugu√™s',tts:'pt-PT', stt:'pt-PT', tag:'PT', tutor:'Treinador de viagem'},
  {key:'pl', label:'Polski',   tts:'pl-PL', stt:'pl-PL', tag:'PL', tutor:'Trener podr√≥≈ºy'},
  {key:'lt', label:'Lietuvi≈≥', tts:'lt-LT', stt:'lt-LT', tag:'LT', tutor:'Kelioni≈≥ treneris'},
  {key:'nl', label:'Nederlands',tts:'nl-NL',stt:'nl-NL', tag:'NL', tutor:'Reiscoach'},
  {key:'sv', label:'Svenska',  tts:'sv-SE', stt:'sv-SE', tag:'SV', tutor:'Resecoach'},
  {key:'da', label:'Dansk',    tts:'da-DK', stt:'da-DK', tag:'DA', tutor:'Rejsecoach'},
  {key:'nb', label:'Norsk',    tts:'nb-NO', stt:'nb-NO', tag:'NO', tutor:'Reisecoach'},
  {key:'fi', label:'Suomi',    tts:'fi-FI', stt:'fi-FI', tag:'FI', tutor:'Matkavalmentaja'},
  {key:'el', label:'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨', tts:'el-GR', stt:'el-GR', tag:'EL', tutor:'Œ†œÅŒøœÄŒøŒΩŒ∑œÑŒÆœÇ œÑŒ±ŒæŒπŒ¥ŒπŒøœç'},
  {key:'cs', label:'ƒåe≈°tina',  tts:'cs-CZ', stt:'cs-CZ', tag:'CS', tutor:'Tren√©r cestov√°n√≠'},
  {key:'hu', label:'Magyar',   tts:'hu-HU', stt:'hu-HU', tag:'HU', tutor:'Utaz√°si edz≈ë'},
  {key:'ro', label:'Rom√¢nƒÉ',   tts:'ro-RO', stt:'ro-RO', tag:'RO', tutor:'Antrenor de cƒÉlƒÉtorie'},
  {key:'bg', label:'–ë—ä–ª–≥–∞—Ä—Å–∫–∏',tts:'bg-BG', stt:'bg-BG', tag:'BG', tutor:'–¢—Ä–µ–Ω—å–æ—Ä –ø–æ –ø—ä—Ç—É–≤–∞–Ω–∏—è'},
];

/* ========================= State & Config ========================= */
const EMBEDDED_OR_KEY = "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"; /* visible in source by request */
const S = {
  level:'A1', scenario:'general',
  stop:true, speaking:false, barge:false,
  xp:0, combo:1, corrStreak:0,
  history:[], memory:"",
  deck: JSON.parse(localStorage.getItem('deck_multi_v2')||'[]'),
  lang: localStorage.getItem('lang_key') || 'es',
  currentIndex: 0, lastExpectedPhrase:"", lastEN:""
};
const cfg = {
  openrouterKey: localStorage.getItem('or_key')||EMBEDDED_OR_KEY,
  openrouterModel: localStorage.getItem('or_model')||'meta-llama/llama-3.2-11b-vision-instruct:free',
  groqKey: localStorage.getItem('groq_key')||''
};

/* ========================= UI refs ========================= */
const chatEl=document.getElementById('chat'), statusEl=document.getElementById('status');
const xpEl=document.getElementById('xp'), xpFill=document.getElementById('xpfill');
const levelEl=document.getElementById('level');
const bar=document.getElementById('langbar');
const sayRes=document.getElementById('sayResult'), sayScoreEl=document.getElementById('sayScore');

/* ========================= Helpers ========================= */
function esc(s){return s.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}
function currentLang(){ return LANGS.find(l=>l.key===S.lang) || LANGS[0]; }
function logAssistant(native,en){ const d=document.createElement('div'); d.className='bubble'; d.innerHTML=`<strong>Tutor:</strong> ${esc(native)}<div class="subtitle">EN: ${esc(en)}</div>`; chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight; }
function logUser(t){ const d=document.createElement('div'); d.className='bubble me'; d.innerHTML=`<strong>You:</strong> ${esc(t)}`; chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight; }
function logSys(t){ const d=document.createElement('div'); d.className='bubble sys'; d.textContent=t; chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight; }
function setStatus(t){ statusEl.textContent=t; }
function addXP(n){ S.xp+=n; xpEl.textContent=S.xp; xpFill.style.width=(S.xp%100)+'%'; }
function renderLangBar(){ bar.innerHTML=''; LANGS.forEach(l=>{ const b=document.createElement('button'); b.className='langbtn'+(l.key===S.lang?' active':''); b.textContent=l.label; b.onclick=()=>{ S.lang=l.key; localStorage.setItem('lang_key',S.lang); resetConversation(true); renderLangBar(); }; bar.appendChild(b); }); }

/* ========================= TTS with barge-in ========================= */
async function speak(text, langCode){
  if(!('speechSynthesis' in window)) return;
  return new Promise(res=>{
    const u=new SpeechSynthesisUtterance(text); u.lang=langCode; u.rate=1.0;
    S.speaking=true; u.onend=()=>{S.speaking=false;res()}; u.onerror=()=>{S.speaking=false;res()};
    try{ speechSynthesis.cancel(); }catch{}
    speechSynthesis.speak(u);
  });
}
function cancelSpeak(){ try{speechSynthesis.cancel();}catch{} S.speaking=false; }

/* ========================= STT (browser or Groq) with barge-in ========================= */
async function listenBrowser(lang){
  return new Promise(resolve=>{
    const Rec=window.webkitSpeechRecognition; if(!Rec){ logSys('Speech recognition not supported.'); return resolve(''); }
    const r=new Rec(); r.lang=lang; r.interimResults=false; r.maxAlternatives=1;
    setStatus('üéôÔ∏è listening‚Ä¶'); let done=false;
    const killer=setTimeout(()=>{ if(!done){ try{r.abort();}catch{} } },16000);
    r.onresult=e=>{done=true; clearTimeout(killer); setStatus('processing‚Ä¶'); resolve(e.results[0]?.[0]?.transcript||'');};
    r.onerror=()=>{if(!done){done=true;clearTimeout(killer);resolve('');}};
    r.onend=()=>{if(!done){done=true;clearTimeout(killer);resolve('');}};
    try{ r.start(); }catch{ resolve(''); }
  });
}
async function recordBlob(ms=8000){
  if(!navigator.mediaDevices?.getUserMedia) return null;
  const stream = await navigator.mediaDevices.getUserMedia({audio:true}); const rec=new MediaRecorder(stream,{mimeType:'audio/webm'});
  const chunks=[]; rec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
  const stopped = new Promise(r=>{ rec.onstop=()=>r(); });
  rec.start(); setStatus('üéôÔ∏è listening‚Ä¶'); await new Promise(r=>setTimeout(r,ms)); rec.stop(); await stopped; stream.getTracks().forEach(t=>t.stop());
  return new Blob(chunks,{type:'audio/webm'});
}
async function listenGroq(lang){
  try{
    const blob = await recordBlob(7000); if(!blob) return '';
    const form = new FormData(); form.append('file', blob, 'speech.webm'); form.append('model','whisper-large-v3-turbo'); form.append('language', (lang||'en-GB').slice(0,2));
    const r = await fetch('https://api.groq.com/openai/v1/audio/transcriptions',{ method:'POST', headers:{'Authorization':'Bearer '+cfg.groqKey}, body:form });
    if(!r.ok) throw new Error('groq stt error'); const j = await r.json(); return j.text || '';
  }catch{ return ''; }
}
async function listen(lang){ return cfg.groqKey ? await listenGroq(lang) : await listenBrowser(lang); }

/* ========================= OpenRouter + WebLLM ========================= */
async function orChat(messages, max=220){
  const body = { model: cfg.openrouterModel, messages, temperature:0.6, max_tokens:max };
  const r = await fetch('https://openrouter.ai/api/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.openrouterKey,'HTTP-Referer': location.origin,'X-Title':'EuroLingo Tutor'},
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error('openrouter error');
  const j = await r.json();
  return (j.choices?.[0]?.message?.content||'').trim();
}
let webllmEngine=null, webllmReady=false;
async function initWebLLM(){
  if(webllmReady) return;
  if(!('mlc' in window)) throw new Error('WebLLM missing');
  const initProgressCallback=(r)=> setStatus('loading: '+(r.text||'')); 
  try{ webllmEngine = await mlc.createMLCEngine("Qwen2-1.5B-Instruct-q4f32_1",{initProgressCallback}); }
  catch{ webllmEngine = await mlc.createMLCEngine("Qwen2-0.5B-Instruct-q4f32_1",{initProgressCallback}); }
  webllmReady=true; setStatus('model ready (local)');
}
async function wllmChat(messages,max=200){
  await initWebLLM();
  const out = await webllmEngine.chat.completions.create({messages, temperature:0.6, max_tokens:max, stream:false});
  return out.choices?.[0]?.message?.content || '';
}

/* ========================= Prompts (with few-shots to avoid ‚ÄúI understand‚Äù) ========================= */
function sysPrompt(){
  const L = currentLang();
  return `
You are "${L.tutor}", a ${L.label} travel tutor for beginners-to-intermediate.
STRICT OUTPUT: two lines only:
${L.tag}: <natural ${L.label}, ‚â§60 words, include a follow-up question, gently correct mistakes inline; if asked "how do I say/what does/(${L.key==='de'?'Was bedeutet':L.key==='fr'?'Que veut dire':L.key==='pl'?'Co znaczy':L.key==='lt'?'KƒÖ rei≈°kia':'¬øQu√© significa'})", GIVE the ${L.label} phrase first (in quotes) then continue the scene.>
EN: <5‚Äì15 word English subtitle of the ${L.tag} line>

Stay in character (restaurant/taxi/directions/hotel/money/emergencies/social). Keep the chat fluid ‚Äî never repeat the same sentence.
Examples:
User: how do I ask for the bill?
${L.tag}: "La cuenta, por favor." ¬øQuieres pagar con tarjeta o en efectivo?
EN: Say ‚ÄúThe bill, please.‚Äù Card or cash?
User: i need a taxi
${L.tag}: Claro. Puedes decir: "Un taxi, por favor." ¬øAd√≥nde vas?
EN: Say ‚ÄúA taxi, please.‚Äù Where are you headed?
`.trim();
}
function parseTwoLines(text){
  const TAG = currentLang().tag;
  const m1 = new RegExp("^\\s*"+TAG+":\\s*(.+)$","im").exec(text||"");
  const m2 = /^\s*EN:\s*(.+)$/im.exec(text||"");
  if(m1&&m2) return {nat:m1[1].trim(), en:m2[1].trim()};
  const lines=(text||'').split('\n').map(s=>s.trim()).filter(Boolean);
  return {nat: lines[0]||'OK.', en: lines[1]||'Understood.'};
}

/* ========================= Scenario detection ========================= */
function detectScenario(t){
  const s=t.toLowerCase();
  if(/resta|menu|camar|rechnung|tisch|gar√ßon|bill|mesa|men√∫|speisekarte|kellner|carte/.test(s)) return 'restaurant';
  if(/taxi|airport|aeropuerto|flughafen|a√©roport|gare|station|metro|bus|train|ubahn|u-bahn/.test(s)) return 'taxi';
  if(/direc|left|right|straight|izquierda|derecha|gauche|droite|links|rechts|geradeaus|wo ist/.test(s)) return 'directions';
  if(/hotel|room|check|llave|schl√ºssel|cl√©|fr√ºhst√ºck|desayuno|reception/.test(s)) return 'hotel';
  if(/money|euros?|price|precio|wie viel|combien|tarjeta|efectivo|cash/.test(s)) return 'money';
  if(/help|ayuda|hilfe|police|polizei|ambulance|apotheke|farmacia|emergen/.test(s)) return 'emergencies';
  if(/friend|foto|recommend|recomienda|empfehl|social|smalltalk|charla|conversa/.test(s)) return 'social';
  return S.scenario||'restaurant';
}

/* ========================= AI Pronunciation/Fluency scoring ========================= */
const bars={pron:document.getElementById('pronBar'),accent:document.getElementById('accentBar'),flu:document.getElementById('fluencyBar'),conf:document.getElementById('confBar')};
const tips={pron:document.getElementById('pronTip'),accent:document.getElementById('accentTip'),flu:document.getElementById('fluencyTip'),conf:document.getElementById('confTip')};
function norm(n){return Math.max(0,Math.min(100,Math.round(n))); }
function heuristicScore(userText, target){ // fallback
  const a=(userText||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  const b=(target||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  const A=new Set(a.split('')); const B=new Set(b.split(''));
  const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size||1;
  const sim=inter/uni;
  return {pron:norm(30+60*sim),accent:norm(30+60*sim),fluency:norm(30+Math.min(70,(userText.split(/\s+/).length||0)*6)),confidence:norm(25+Math.min(75,(userText.length||0)/40*75)),feedback:"Heuristic check only."};
}
async function aiScore(userText, targetLangCode, expected){
  try{
    const TAG=currentLang().tag;
    const sys=`You are a pronunciation coach for ${currentLang().label}. Return STRICT JSON only with keys: pron, accent, fluency, confidence (0-100 integers) and feedback (<=15 words). Be strict if the text is English or wrong language.`;
    const user=`LanguageTag=${TAG}\nTarget="${expected||''}"\nUserSaid="${userText||''}"\nRate their ${TAG} pronunciation and speaking.`;
    const raw = await orChat([{role:'system',content:sys},{role:'user',content:user}], 150);
    const json = JSON.parse((raw.match(/\{[\s\S]*\}$/)||[raw])[0]);
    return {
      pron:norm(json.pron), accent:norm(json.accent), fluency:norm(json.fluency), confidence:norm(json.confidence),
      feedback: String(json.feedback||'Good effort.').slice(0,60)
    };
  }catch(e){ return heuristicScore(userText, expected); }
}
function updateMetersFrom(obj){
  bars.pron.style.width=obj.pron+'%'; tips.pron.textContent = obj.feedback||'';
  bars.accent.style.width=obj.accent+'%'; tips.accent.textContent = obj.accent<55?'Mind stress & vowels.':'Accent improving.';
  bars.fluency.style.width=obj.fluency+'%'; tips.fluency.textContent = obj.fluency<55?'Short complete clauses.':'Good flow.';
  bars.conf.style.width=obj.confidence+'%'; tips.conf.textContent = obj.confidence<55?'Steady pace, project.':'Confident tone.';
}

/* ========================= Flashcards (SRS) ========================= */
const FC={front:document.getElementById('fcFront'),back:document.getElementById('fcBack'),dueCount:document.getElementById('dueCount'),deckInfo:document.getElementById('deckInfo')};
const sayResEl=document.getElementById('sayResult');
function days(n){return n*24*60*60*1000}
function saveDeck(){ localStorage.setItem('deck_multi_v2', JSON.stringify(S.deck)); }
function newCard(frontEN,backNative,module){return {id:(module||'focus')+'::'+backNative,frontEN,backNative,ease:2.5,interval:0,due:Date.now(),reps:0,lapses:0,module:module||'focus'}}
function reviewCard(c,g){const n={...c}; if(g===0){n.lapses++;n.interval=0;n.ease=Math.max(1.3,n.ease-0.2);n.due=Date.now()+days(0.04);} else {if(n.interval===0)n.interval=(g===3?3:1); else if(n.interval===1)n.interval=(g===3?6:3); else n.interval=Math.round(n.interval*(n.ease)*(g===1?0.7:1)); n.ease=Math.max(1.3,n.ease+(g===3?0.15:(g===1?-0.05:0.05))); n.due=Date.now()+days(n.interval);} n.reps++; return n;}
function addToDeck(frontEN,backNative,module){ if(!frontEN||!backNative) return; if(S.deck.find(d=>d.id===(module||'focus')+'::'+backNative)) return; S.deck.push(newCard(frontEN,backNative,module)); saveDeck(); }
function showCard(idx){
  if(!S.deck.length){ FC.front.textContent="No cards yet."; FC.back.textContent="Practice will appear here."; FC.back.style.display='none'; FC.front.style.display='flex'; FC.dueCount.textContent='0'; FC.deckInfo.textContent='Module: ‚Äî'; return; }
  S.currentIndex = ((idx%S.deck.length)+S.deck.length)%S.deck.length;
  const c=S.deck[S.currentIndex]; FC.front.textContent=c.frontEN; FC.back.textContent=c.backNative;
  FC.front.style.display='flex'; FC.back.style.display='flex';
  const due=S.deck.filter(k=>k.due<=Date.now()); FC.dueCount.textContent=String(due.length||S.deck.length);
  FC.deckInfo.textContent='Module: '+(c.module||'focus'); S.lastExpectedPhrase=c.backNative; S.lastEN=c.frontEN;
}
function gradeCard(g){ if(!S.deck.length) return; const i=S.currentIndex; S.deck[i]=reviewCard(S.deck[i],g); saveDeck(); showCard(i+1); addXP(g>=2?8:2); }

/* ========================= Conversation ========================= */
function baseSystem(){ return sysPrompt() + `\nCurrent scenario: ${S.scenario}. Keep it friendly and fluid.`; }
function buildMessages(userText){ const msgs=[{role:'system',content:baseSystem()},...S.history.slice(-10)]; if(userText!=null) msgs.push({role:'user',content:userText}); return msgs; }
async function converse(userText){
  let raw=''; try{ raw = await orChat(buildMessages(userText)); }catch{ try{ raw = await wllmChat(buildMessages(userText)); }catch{ raw=''; } }
  let {nat,en}=parseTwoLines(raw);
  // If the model went bland, synthesize a direct, scenario-specific reply:
  if(!nat || /^ok\.?|understood\.?$/i.test(en)) {
    const L=currentLang(); if(/taxi|cab/i.test(userText)) { nat=`"Un taxi, por favor." ¬øAd√≥nde vas?`; en=`Say ‚ÄúA taxi, please.‚Äù Where to?`; }
    else if(/bill|check|cuenta|rechnung|addition/i.test(userText)) { nat=`"La cuenta, por favor." ¬øPagas con tarjeta o efectivo?`; en=`Say ‚ÄúThe bill, please.‚Äù Card or cash?`; }
  }
  return {nat,en};
}
function harvestPhrase(nativeText, enSubtitle){
  const m = nativeText.match(/[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]([^‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]+)[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]/);
  const phrase=(m?.[1]||'').trim(); if(phrase) addToDeck(enSubtitle||'‚Äî', phrase, S.scenario);
}

/* ========================= Turn engine with barge-in ========================= */
let recognizing=false, recPromise=null;
async function bargeListen(lang){
  recognizing=true;
  const p = listen(lang).then(t=>{recognizing=false; return t;});
  recPromise=p; return p;
}
async function start(){
  if(!S.stop) return; S.stop=false; levelEl.textContent=S.level;
  const L=currentLang();
  // Greeting
  const greetMap={
    es:"Hola, soy tu profe de viaje. ¬øQu√© practicamos: restaurante, taxi, direcciones, hotel, dinero, emergencias o social?",
    de:"Hallo, ich bin dein Reisecoach. Was √ºben wir: Restaurant, Taxi, Wegbeschreibung, Hotel, Geld, Notf√§lle oder Smalltalk?",
    fr:"Salut, je suis ton coach de voyage. On pratique quoi : restaurant, taxi, directions, h√¥tel, argent, urgences ou social ?",
    it:"Ciao, sono il tuo coach di viaggio. Che cosa alleniamo: ristorante, taxi, indicazioni, hotel, soldi, emergenze o sociale?",
    pt:"Ol√°, sou o seu treinador de viagem. O que praticamos: restaurante, t√°xi, dire√ß√µes, hotel, dinheiro, emerg√™ncias ou social?",
    pl:"Cze≈õƒá, jestem Twoim trenerem podr√≥≈ºy. Co ƒáwiczymy: restauracja, taks√≥wka, wskaz√≥wki, hotel, pieniƒÖdze, nag≈Çe wypadki czy rozmowa?",
    lt:"Sveikas, a≈° tavo kelioni≈≥ treneris. KƒÖ treniruojame: restoranƒÖ, taksi, kryptis, vie≈°butƒØ, pinigus, skubius atvejus ar pokalbƒØ?",
    nl:"Hoi, ik ben je reiscoach. Wat oefenen we: restaurant, taxi, route, hotel, geld, noodgevallen of sociaal?",
    sv:"Hej, jag √§r din resecoach. Vad √∂var vi: restaurang, taxi, v√§gbeskrivning, hotell, pengar, n√∂dfall eller socialt?",
    da:"Hej, jeg er din rejsecoach. Hvad √∏ver vi: restaurant, taxi, vejvisning, hotel, penge, n√∏dsituationer eller socialt?",
    nb:"Hei, jeg er din reisecoach. Hva √∏ver vi: restaurant, taxi, veibeskrivelse, hotell, penger, n√∏dstilfeller eller sosialt?",
    fi:"Hei, olen matkavalmentajasi. Mit√§ harjoitellaan: ravintola, taksi, reitit, hotelli, raha, h√§t√§tilanteet vai small talk?",
    el:"ŒìŒµŒπŒ±, ŒµŒØŒºŒ±Œπ Œø œÄœÅŒøœÄŒøŒΩŒ∑œÑŒÆœÇ œÑŒ±ŒæŒπŒ¥ŒπŒøœç œÉŒøœÖ. Œ§Œπ ŒµŒæŒ±œÉŒ∫ŒøœçŒºŒµ: ŒµœÉœÑŒπŒ±œÑœåœÅŒπŒø, œÑŒ±ŒæŒØ, ŒøŒ¥Œ∑Œ≥ŒØŒµœÇ, ŒæŒµŒΩŒøŒ¥ŒøœáŒµŒØŒø, œáœÅŒÆŒºŒ±œÑŒ±, ŒµœÄŒµŒØŒ≥ŒøŒΩœÑŒ± ŒÆ Œ∫ŒøœÖŒ≤Œ≠ŒΩœÑŒ±;",
    cs:"Ahoj, jsem tv≈Øj tren√©r cestov√°n√≠. Co budeme tr√©novat: restaurace, taxi, navigace, hotel, pen√≠ze, pohotovost nebo konverzace?",
    hu:"Szia, az utaz√°si edz≈ëd vagyok. Mit gyakoroljunk: √©tterem, taxi, √∫tbaigaz√≠t√°s, hotel, p√©nz, v√©szhelyzet vagy t√°rsalg√°s?",
    ro:"Salut, sunt antrenorul tƒÉu de cƒÉlƒÉtorie. Ce exersƒÉm: restaurant, taxi, indica»õii, hotel, bani, urgen»õe sau social?",
    bg:"–ó–¥—Ä–∞—Å—Ç–∏, –∞–∑ —Å—ä–º —Ç–≤–æ—è—Ç —Ç—Ä–µ–Ω—å–æ—Ä –ø–æ –ø—ä—Ç—É–≤–∞–Ω–∏—è. –ö–∞–∫–≤–æ —É–ø—Ä–∞–∂–Ω—è–≤–∞–º–µ: —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç, —Ç–∞–∫—Å–∏, —É–∫–∞–∑–∞–Ω–∏—è, —Ö–æ—Ç–µ–ª, –ø–∞—Ä–∏, —Å–ø–µ—à–Ω–∏ —Å–ª—É—á–∞–∏ –∏–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä?"
  };
  const greet=greetMap[L.key]||"Hola, empecemos. ¬øQu√© situaci√≥n quieres practicar?";
  logAssistant(greet,"Hi! Which situation shall we practice?");
  // Start speaking AND listening at once; if user speaks, we barge-in (cancel TTS)
  const speakP = speak(greet, L.tts);
  const hearP  = bargeListen(S.level==='A1'?'en-GB':L.stt);
  const firstHeard = await Promise.race([speakP.then(()=>''), hearP]);
  if(firstHeard){ cancelSpeak(); logUser(firstHeard); S.scenario=detectScenario(firstHeard); await handleTurn(firstHeard); }

  while(!S.stop){
    const heard = await bargeListen(S.level==='A1'?'en-GB':L.stt); if(S.stop) break; if(!heard) continue;
    logUser(heard); S.scenario=detectScenario(heard);
    await handleTurn(heard);
  }
}
async function handleTurn(heard){
  // respond
  const {nat,en}=await converse(heard);
  logAssistant(nat,en); S.lastExpectedPhrase = nat; S.lastEN = en;
  await speak(nat,currentLang().tts); // will be interrupted if user barges in
  // save history
  S.history.push({role:'user',content:heard}); S.history.push({role:'assistant',content:`${currentLang().tag}: ${nat}\nEN: ${en}`});
  harvestPhrase(nat,en); addXP(6);
  // AI pronunciation/fluency scoring (compare to expected phrase if quoted, else to nat text)
  const expected = (nat.match(/[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]([^‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]+)[‚Äú‚Äù"‚Äû¬´¬ª‚Äö‚Äò‚Äô‚Äπ‚Ä∫]/)?.[1]||nat);
  const score = await aiScore(heard,currentLang().stt,expected);
  updateMetersFrom(score);
}

/* ========================= Controls & Settings ========================= */
document.getElementById('startBtn').onclick=()=>{ S.stop=false; setStatus('starting‚Ä¶'); start(); };
document.getElementById('stopBtn').onclick=()=>{ S.stop=true; cancelSpeak(); setStatus('stopped'); };
document.getElementById('interruptBtn').onclick=()=>{ cancelSpeak(); setStatus('interrupted ‚Üí listening'); };
document.getElementById('saveOR').onclick=()=>{ const k=(document.getElementById('orKey').value||'').trim(); const m=(document.getElementById('orModel').value||'').trim(); if(k) cfg.openrouterKey=k; cfg.openrouterModel=m||cfg.openrouterModel; localStorage.setItem('or_key',cfg.openrouterKey); localStorage.setItem('or_model',cfg.openrouterModel); document.getElementById('orStatus').textContent = 'OpenRouter ready.'; };
document.getElementById('saveGroq').onclick=()=>{ cfg.groqKey=(document.getElementById('groqKey').value||'').trim(); localStorage.setItem('groq_key',cfg.groqKey); document.getElementById('groqStatus').textContent = cfg.groqKey? 'STT via Groq Whisper':'STT via browser'; };

/* ========================= Flashcard handlers ========================= */
document.getElementById('showCard').onclick=()=>{ const front=document.getElementById('fcFront'); const back=document.getElementById('fcBack'); const isBack=back.style.display!=='none'; back.style.display=isBack?'none':'flex'; };
document.getElementById('prevCard').onclick=()=>{ if(S.deck.length) showCard(S.currentIndex-1); };
document.getElementById('nextCard').onclick=()=>{ if(S.deck.length) showCard(S.currentIndex+1); };
document.getElementById('again').onclick=()=>gradeCard(0);
document.getElementById('hard').onclick=()=>gradeCard(1);
document.getElementById('good').onclick=()=>gradeCard(2);
document.getElementById('easy').onclick=()=>gradeCard(3);
document.getElementById('speakCard').onclick=()=>{ const c=S.deck[S.currentIndex]; if(c) speak(c.backNative,currentLang().tts); };
document.getElementById('sayCard').onclick=async()=>{
  const c=S.deck[S.currentIndex]; if(!c) return;
  const heard = await listen(currentLang().stt); sayRes.textContent = heard?('You said: '+heard):'';
  if(!heard) return;
  const result = await aiScore(heard,currentLang().stt,c.backNative);
  updateMetersFrom(result);
  const label = result.pron>=85?'Excellent':result.pron>=70?'Good':result.pron>=50?'Fair':'Poor';
  sayScoreEl.textContent = `Score: ${label} (${result.pron})`;
};

/* ========================= Init ========================= */
(function init(){
  renderLangBar();
  document.getElementById('streak').textContent='0'; document.getElementById('combo').textContent='x1';
  xpEl.textContent='0'; levelEl.textContent=S.level;
  // Seed cross-language starter cards if needed
  if(!S.deck.length){
    addToDeck("A table for two, please","Una mesa para dos, por favor","restaurant");
    addToDeck("To the airport, please","Zum Flughafen, bitte.","taxi");
    addToDeck("Where is the metro station?","O√π est la station de m√©tro ?","directions");
    addToDeck("The bill, please","La cuenta, por favor","restaurant");
  }
  showCard(0);
  logSys("Ready. Press Start. It will speak and listen immediately; you can interrupt it at any time.");
})();
</script>
</body>
</html>
